{% extends "base.html" %}

{% block content %}
<h2>Web Clipper</h2>
<p>Save content from web pages by entering the URL below.</p>

<div style="margin: 20px 0;">
    <div style="display: flex; margin-bottom: 20px;">
        <input type="url" id="web-url" placeholder="https://example.com" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px 0 0 4px;">
        <button class="btn" id="clip-btn" style="border-radius: 0 4px 4px 0;">Clip Content</button>
    </div>
    
    <div style="margin-bottom: 20px;">
        <input type="text" id="clip-tags" placeholder="Add tags (comma separated)" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
    </div>
    
    <div id="clip-status"></div>
</div>

<hr style="margin: 30px 0;">

<h3>Clipped Web Pages</h3>
<div id="clips-list">
    <p>Loading your web clips...</p>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load web clips
        loadWebClips();
        
        // Clip button handler
        document.getElementById('clip-btn').addEventListener('click', clipWebPage);
    });
    
    function loadWebClips() {
        fetch('/api/web_clips')
            .then(response => response.json())
            .then(clips => {
                const clipsList = document.getElementById('clips-list');
                
                if (clips.length === 0) {
                    clipsList.innerHTML = '<p>You haven\'t clipped any web pages yet.</p>';
                    return;
                }
                
                clipsList.innerHTML = '';
                
                clips.forEach(clip => {
                    const clipElement = document.createElement('div');
                    clipElement.style.background = '#f8f9fa';
                    clipElement.style.padding = '15px';
                    clipElement.style.borderRadius = '8px';
                    clipElement.style.marginBottom = '15px';
                    
                    clipElement.innerHTML = `
                        <h4><a href="${clip.url}" target="_blank">${clip.title}</a></h4>
                        <p>URL: ${clip.url}</p>
                        <p>Clipped: ${new Date(clip.clipped_at).toLocaleDateString()}</p>
                        <p>${clip.content.substring(0, 100)}${clip.content.length > 100 ? '...' : ''}</p>
                        <div style="margin-top: 10px;">
                            ${clip.tags.map(tag => `<span style="background: #6b8cae; color: white; padding: 3px 8px; border-radius: 20px; font-size: 12px; margin-right: 5px;">${tag}</span>`).join('')}
                        </div>
                        <div style="margin-top: 10px;">
                            <button onclick="deleteClip('${clip.id}')" class="btn btn-accent" style="padding: 5px 10px; font-size: 14px;">Delete</button>
                        </div>
                    `;
                    
                    clipsList.appendChild(clipElement);
                });
            })
            .catch(error => {
                console.error('Error loading web clips:', error);
                document.getElementById('clips-list').innerHTML = '<p>Error loading web clips. Please try again.</p>';
            });
    }
    
    function clipWebPage() {
        const url = document.getElementById('web-url').value;
        const tags = document.getElementById('clip-tags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
        const statusElement = document.getElementById('clip-status');
        
        if (!url) {
            alert('Please enter a URL');
            return;
        }
        
        statusElement.innerHTML = '<p>Clipping web page content...</p>';
        
        fetch('/api/web_clips', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                url: url,
                tags: tags
            })
        })
        .then(response => response.json())
        .then(clip => {
            statusElement.innerHTML = `<p>Web page clipped successfully!</p>`;
            
            // Clear the form
            document.getElementById('web-url').value = '';
            document.getElementById('clip-tags').value = '';
            
            // Reload web clips
            loadWebClips();
        })
        .catch(error => {
            console.error('Error clipping web page:', error);
            statusElement.innerHTML = '<p>Error clipping web page. Please try again.</p>';
        });
    }
    
    function deleteClip(clipId) {
        if (confirm('Are you sure you want to delete this web clip?')) {
            fetch(`/api/web_clips/${clipId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(result => {
                // Reload web clips
                loadWebClips();
                alert('Web clip deleted successfully!');
            })
            .catch(error => {
                console.error('Error deleting web clip:', error);
                alert('Error deleting web clip. Please try again.');
            });
        }
    }
</script>
{% endblock %}