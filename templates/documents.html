{% extends "base.html" %}

{% block content %}
<h2>Documents</h2>
<p>Upload documents (PDF, Word, text files) to extract and store their content.</p>

<div style="margin: 20px 0;">
    <div style="border: 2px dashed #ddd; border-radius: 8px; padding: 30px; text-align: center; margin-bottom: 20px; cursor: pointer;" id="drop-zone">
        <p>Drag & drop files here or click to browse</p>
        <input type="file" id="file-input" style="display: none;" multiple accept=".pdf,.doc,.docx,.txt">
    </div>
    
    <div style="margin-bottom: 20px;">
        <input type="text" id="doc-tags" placeholder="Add tags (comma separated)" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
    </div>
    
    <div id="upload-status"></div>
</div>

<hr style="margin: 30px 0;">

<h3>Uploaded Documents</h3>
<div id="documents-list">
    <p>Loading your documents...</p>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load documents
        loadDocuments();
        
        // Set up file upload
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        
        dropZone.addEventListener('click', () => {
            fileInput.click();
        });
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#4a6fa5';
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.style.borderColor = '#ddd';
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#ddd';
            
            const files = e.dataTransfer.files;
            handleFiles(files);
        });
        
        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files);
        });
    });
    
    function loadDocuments() {
        fetch('/api/documents')
            .then(response => response.json())
            .then(documents => {
                const documentsList = document.getElementById('documents-list');
                
                if (documents.length === 0) {
                    documentsList.innerHTML = '<p>You haven\'t uploaded any documents yet.</p>';
                    return;
                }
                
                documentsList.innerHTML = '';
                
                documents.forEach(doc => {
                    const docElement = document.createElement('div');
                    docElement.style.background = '#f8f9fa';
                    docElement.style.padding = '15px';
                    docElement.style.borderRadius = '8px';
                    docElement.style.marginBottom = '15px';
                    
                    docElement.innerHTML = `
                        <h4>${doc.original_name}</h4>
                        <p>Uploaded: ${new Date(doc.uploaded_at).toLocaleDateString()}</p>
                        <p>${doc.text_content.substring(0, 100)}${doc.text_content.length > 100 ? '...' : ''}</p>
                        <div style="margin-top: 10px;">
                            ${doc.tags.map(tag => `<span style="background: #6b8cae; color: white; padding: 3px 8px; border-radius: 20px; font-size: 12px; margin-right: 5px;">${tag}</span>`).join('')}
                        </div>
                        <div style="margin-top: 10px;">
                            <button onclick="deleteDocument('${doc.id}')" class="btn btn-accent" style="padding: 5px 10px; font-size: 14px;">Delete</button>
                        </div>
                    `;
                    
                    documentsList.appendChild(docElement);
                });
            })
            .catch(error => {
                console.error('Error loading documents:', error);
                document.getElementById('documents-list').innerHTML = '<p>Error loading documents. Please try again.</p>';
            });
    }
    
    function handleFiles(files) {
        const statusElement = document.getElementById('upload-status');
        const tags = document.getElementById('doc-tags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
        
        if (files.length === 0) return;
        
        statusElement.innerHTML = '<p>Uploading files...</p>';
        
        Array.from(files).forEach(file => {
            const formData = new FormData();
            formData.append('file', file);
            tags.forEach(tag => formData.append('tags[]', tag));
            
            fetch('/api/documents', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(document => {
                statusElement.innerHTML = `<p>File "${file.name}" uploaded successfully!</p>`;
                
                // Clear tags input
                document.getElementById('doc-tags').value = '';
                
                // Reload documents
                loadDocuments();
            })
            .catch(error => {
                console.error('Error uploading file:', error);
                statusElement.innerHTML = `<p>Error uploading "${file.name}". Please try again.</p>`;
            });
        });
    }
    
    function deleteDocument(docId) {
        if (confirm('Are you sure you want to delete this document?')) {
            fetch(`/api/documents/${docId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(result => {
                // Reload documents
                loadDocuments();
                alert('Document deleted successfully!');
            })
            .catch(error => {
                console.error('Error deleting document:', error);
                alert('Error deleting document. Please try again.');
            });
        }
    }
</script>
{% endblock %}